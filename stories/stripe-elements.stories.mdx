import {
  html,
  Meta,
  Preview,
  Props,
  Story,
} from '@open-wc/demoing-storybook';

import '../stripe-elements.js';

import '@power-elements/json-viewer';
import '@material/mwc-textfield';
import '@material/mwc-button';

import { publishableKey, $, $$, setKeys } from './helpers.js';

<Meta
  title="Stripe Elements"
  parameters={{
    component: 'stripe-elements',
    options: { selectedPanel: 'storybookjs/docs/panel' }
  }}
/>

# Stripe Elements Web Component

The `<stripe-elements>` custom element is an easy way to use stripe.js in your web app.
To get started, add the element to your page with the `publishable-key` attribute set to your
[Stripe publishable key](https://dashboard.stripe.com/account/apikeys). You can also set the `publishableKey` DOM property using JavaScript

```html
<stripe-elements publishable-key="my-pk"></stripe-elements>
```

**Careful!** never add your **secret key** to an HTML page, only publish your **publishable key**.

Once you've set the `publishable-key` attribute (or the `publishableKey` DOM property), Stripe will create a Stripe Card Element on your page.

Enter your publishable key here (use the test key, not the production key) to run the examples against your Stripe account. **Note**: This demo will store the publishable key in localstorage for your convenience.

<Story name="Enter a Stripe Publishable Key" height="80px">
  {html`
    <mwc-textfield id="publishable-key-input"
        outlined
        value="${publishableKey}"
        label="Publishable Key"
        @change="${setKeys('stripe-elements:not(#should-error)')}">
    </mwc-textfield>`
  }
</Story>


## Create a Token

Once you're set your publishable key and Stripe has instantiated (listen for the `stripe-ready` event if you need to know exactly when this happens),
you may generate a token from the filled-out form by calling the `createToken()` method.

<Preview>
  <Story name="Generate a Token" height="60px">
    {
      () => {
        const viewer = $('#token-viewer');
        const onStripeToken = event => viewer.object = event.detail;
        const onClick = () => $('#token stripe-elements').createToken();
        return html`
        <section id="token">
          <stripe-elements publishable-key="${publishableKey}" @stripe-token="${onStripeToken}"></stripe-elements>
          <mwc-button class="generate" outlined @click="${onClick}">Generate Token</mwc-button>
        </section>`
      }
    }
  </Story>
</Preview>

<json-viewer id="token-viewer"></json-viewer>

## Create a Source

<Preview>
  <Story name="Generate a Source" height="200px">
    {
      () => {
        const onStripeSource = event => $('#source-viewer').object = event.detail;
        const fieldEntry = field => [field.dataset.ownerProp, field.value];
        const getCardData = () => Object.fromEntries($$('#source mwc-textfield').map(fieldEntry));
        const onClick = () => $('#source stripe-elements').createSource({ type: 'card', owner: getCardData() });
        return html`
        <section id="source">
          <stripe-elements id="source-element" publishable-key="${publishableKey}" @stripe-source="${onStripeSource}"></stripe-elements>
          <mwc-textfield outlined label="Cardholder Name" data-owner-prop="name"></mwc-textfield>
          <mwc-textfield outlined label="Cardholder Email" data-owner-prop="email"></mwc-textfield>
          <mwc-textfield outlined label="Cardholder Phone" data-owner-prop="phone"></mwc-textfield>
          <mwc-button outlined @click="${onClick}">Generate Source</mwc-button>
        </section>
        `
      }
    }
  </Story>
</Preview>

<json-viewer id="source-viewer"></json-viewer>

## Validation

`<stripe-elements>` has a `show-error` boolean attribute which will display the error message for you.
This is useful for simple validation in cases where you don't need to build your own validation UI.

<Preview>
  <Story name="Error Display" height="60px">
    {
      () => {
        const onClick = () => $('#should-error').validate();
        return html`
        <section id="show-errror">
          <stripe-elements id="should-error" publishable-key="should-error-use-bad-key" show-error></stripe-elements>
          <mwc-button class="generate" outlined @click="${onClick}">Validate</mwc-button>
        </section>`
      }
    }
  </Story>
</Preview>

## Advanced Validation

`<stripe-elements>` comes with several properties, events, and methods for validation.
Listen for the `is-complete-changed`, `is-empty-changed`, and `has-error-changed` events
and check the `isComplete`, `isEmpty`, and `hasError` properties to react to validation changes.
These properties to their dash-cased attributes,
so you can use CSS to style your element in its various states.

```css
stripe-elements[is-empty] { border: 1px solid rebeccapurple; }
stripe-elements[is-complete] { border: 1px solid blue; }
stripe-elements[has-error] { border: 1px solid red; }
```

<Preview>
  <Story name="Validation States" height="60px">
    {
      () => {
        const onClick = () => $('#states stripe-elements').validate();
        return html`
        <style>
          stripe-elements { border-radius: 4px; }
          stripe-elements[is-empty] { border: 1px solid rebeccapurple; }
          stripe-elements[is-complete] { border: 1px solid blue; }
          stripe-elements[has-error] { border: 1px solid red; }
        </style>
        <section id="states">
          <stripe-elements publishable-key="${publishableKey}"></stripe-elements>
          <mwc-button class="generate" outlined @click="${onClick}">Validate</mwc-button>
        </section>`
      }
    }
  </Story>
</Preview>

For more complex needs, you can listen for the `stripe-error` event.

# Using `<stripe-elements>` Across Frameworks

Since `<stripe-elements>` is a custom-element, you can easily use it across frameworks.

<Story name="In Plain HTML and JavaScript"> </Story>

## Using with Plain HTML and JavaScript

```html
<script type="module" src="https://unpkg.com/@power-elements/stripe-elements/stripe-elements.js?module"></script>
<script type="module" src="https://unpkg.com/@power-elements/json-viewer/json-viewer.js?module"></script>

<stripe-elements id="stripe"
    action="/payment"
    publishable-key="pk_test_XXXXXXXXXXXXXXXXXXXXXXXX"
></stripe-elements>

<button id="submit" disabled>Submit</button>
<json-viewer id="json"></json-viewer>

<script>
  const handleAsJson = response => response.json();
  const viewJson = object => json.object = object;
  const viewer = document.getElementById('json');
  const stripe = document.getElementById('stripe');
  const submit = document.getElementById('button');

  submit.addEventListener('click', onClickSubmit);
  stripe.addEventListener('stripe-source', onStripeSource);
  stripe.addEventListener('change', onChange);

  function onClickSubmit() {
    stripe.createSource();
  }

  function onChange({ target }) {
    button.disabled = !target.validate();
  }

  function onStripeSource({ target: { source } }) {
    const method = 'POST';
    const body = JSON.stringify(source);
    const headers = { 'Content-Type': 'application/json' };
    fetch('/payments', { method, body, headers })
      .then(handleAsJson)
      .then(viewJson)
      .catch(viewJson);
  }
</script>
```

<Story name="In a LitElement"> </Story>

## In a `LitElement`

```js
import '@power-elements/stripe-elements/stripe-elements.js';
import { LitElement, html } from 'lit-element';
import { PUBLISHABLE_KEY } from './config.js';

class PaymentForm extends LitElement {
  render() {
    return html`
      <stripe-elements id="stripe"
          @stripe-change="${this.onChange}"
          publishable-key="${PUBLISHABLE_KEY}"
          action="/payment"
      ></stripe-elements>
      <button disabled @click="${this.onClick}">Get Token</button>
    `;
  }

  onChange({ target: { isComplete, hasError } }) => {
    this.shadowRoot.querySelector('button').disabled = !(isComplete && !hasError)
  }

  onClick() {
    this.shadowRoot.getElementById('stripe').createSource();
  }
}
```

<Story name="In a Polymer Element"> </Story>

### In a Polymer Element

```html
<paper-input label="Stripe Publishable Key" value="{{key}}"></paper-input>

<stripe-elements id="stripe"
    stripe-ready="{{ready}}"
    publishable-key="[[key]]"
    token="{{token}}"
></stripe-elements>

<paper-button id="submit"
    disabled="[[!ready]]"
    onclick="stripe.createSource()">
  Get Token
</paper-button>

<paper-toast
    opened="[[token]]"
    text="Token received for ðŸ’³ [[token.card.last4]]! ðŸ¤‘"
></paper-toast>
```

<Story name="In a Vue Component"> </Story>

### In a Vue Component

<iframe
   src="https://codesandbox.io/embed/stripe-elements-web-component-vue-06ulb?fontsize=14&hidenavigation=1&module=%2Fsrc%2FPayment.vue&theme=dark"
   style={{ width:"100%", height:'500px', border:0, borderRadius: "4px", overflow:"hidden" }}
   title="stripe-elements-web-component-vue"
   allow="geolocation; microphone; camera; midi; vr; accelerometer; gyroscope; payment; ambient-light-sensor; encrypted-media; usb"
   sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin">
</iframe>

```html
<template>
  <article>
    <stripe-elements
      ref="stripe"
      @stripe-change="onChange"
      @stripe-token="onToken"
      @stripe-error="onError"
      :publishable-key="publishableKey"
    ></stripe-elements>

    <button :disabled="!isComplete || isEmpty" @click="onClick">Get Token</button>

    <output v-if="token">Token: {{token.id}}</output>
    <output v-if="error">Error: {{error.message}}</output>
  </article>
</template>

<script>
export default {
  name: "payment-form",
  data() {
    return {
      publishableKey: null,
      token: null,
      error: null,
      isComplete: false,
      isEmpty: true
    };
  },
  methods: {
    onChange({ target: { isComplete, isEmpty } }) {
      this.isComplete = isComplete;
      this.isEmpty = isEmpty;
    },

    onClick() {
      this.$refs.stripe.createToken();
    },

    onToken({ detail: token }) {
      this.token = token;
    },

    onError({ detail: error }) {
      this.error = error;
    },
  }
};
</script>
```

<Story name="In an Angular Component"> </Story>

### In an Angular Component

<iframe
     src="https://codesandbox.io/embed/stripe-elements-web-component-angular-0mgh4?fontsize=14&hidenavigation=1&module=%2Fsrc%2Fapp%2Fapp.component.ts&theme=dark"
     style={{ width:"100%", height:'500px', border:0, borderRadius: "4px", overflow:"hidden" }}
     title="stripe-elements-web-component-angular"
     allow="geolocation; microphone; camera; midi; vr; accelerometer; gyroscope; payment; ambient-light-sensor; encrypted-media; usb"
     sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin">
</iframe>

```ts
import { Component } from "@angular/core";

// trick to get syntax highlighting
const html = x => x;
const template = html`
  <mwc-textfield
    #key
    (change)="setKey(key)"
    label="Publishable Key"
  ></mwc-textfield>

  <stripe-elements
    #stripe
    (stripe-change)="disabled = !$event.target.isComplete"
    (stripe-token)="token = $event.detail"
    (stripe-error)="error = $event.detail"
    [publishableKey]="publishableKey"
  ></stripe-elements>

  <mwc-button [disabled]="disabled" (click)="createToken(stripe)">
    Get Token
  </mwc-button>

  <output *ngIf="token">{{ token.id }}</output>
  <output *ngIf="error">{{ error.message }}</output>
`;

@Component({ selector: "app-root", template })
export class AppComponent {
  publishableKey: string;
  disabled = true;
  token?: stripe.Token = null;
  error?: Error | stripe.Error = null;

  createToken(stripeElements: any) {
    stripeElements.createToken();
  }

  setKey({ value }) {
    this.publishableKey = value;
  }
}
```

<Story name="In a React Component"> </Story>

### In a React Component

<iframe
     src="https://codesandbox.io/embed/stripe-elements-web-component-react-23zw8?fontsize=14&hidenavigation=1&theme=dark"
     style={{ width:"100%", height:'500px', border:0, borderRadius: "4px", overflow:"hidden" }}
     title="stripe-elements-web-component-react"
     allow="geolocation; microphone; camera; midi; vr; accelerometer; gyroscope; payment; ambient-light-sensor; encrypted-media; usb"
     sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin">
</iframe>

```jsx
import { useState, useRef, useEffect } from "react";
import { getPropOr, compose } from "crocks";
import "./styles.css";

const isDisabled = ({ isComplete, isEmpty }) => !isComplete || isEmpty;
const getTarget = getPropOr({}, "target");
const getDetail = getPropOr(null, "detail");
const getToken = getPropOr(null, "token");

export default () => {
  const stripeRef = useRef(null);
  const [publishableKey, setPublishableKey] = useState(null);
  const [disabled, setDisabled] = useState(true);
  const [token, setToken] = useState(null);
  const [error, setError] = useState(null);
  const setKey = ({ target: { value } }) => setPublishableKey(value);

  const onChange = compose(setDisabled, isDisabled, getTarget);
  const onError = compose(setError, getDetail);
  const onToken = compose(setToken, getToken);

  const onClick = async () =>
    stripeRef.current.createToken()
      .then(getToken)
      .then(setToken);

  useEffect(() => {
    stripeRef.current.addEventListener("stripe-change", onChange);
    stripeRef.current.addEventListener("stripe-error", onError);
    stripeRef.current.addEventListener("stripe-token", onToken);
  });

  return (
    <article className="App">
      <label>
        Publishable Key
        <input onChange={setKey} />
      </label>
      <stripe-elements ref={stripeRef} publishable-key={publishableKey} />
      <button onClick={onClick} disabled={disabled}>
        Submit
      </button>
      {token && <output>{token.id}</output>}
      {error && <output>{error.message}</output>}
    </article>
  );
};
```

<Story name="In a Preact Component"> </Story>

### In a Preact Component

<iframe
     src="https://codesandbox.io/embed/stripe-elements-web-component-preact-mqskb?fontsize=14&hidenavigation=1&theme=dark"
     style={{ width:"100%", height:'500px', border:0, borderRadius: "4px", overflow:"hidden" }}
     title="stripe-elements-web-component-preact"
     allow="geolocation; microphone; camera; midi; vr; accelerometer; gyroscope; payment; ambient-light-sensor; encrypted-media; usb"
     sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin">
</iframe>

```jsx
import { render } from "preact";
import { useState, useRef } from "preact/hooks";
import { getPropOr, compose } from "crocks";
import "./style";

const isDisabled = ({ isComplete, isEmpty }) => !isComplete || isEmpty;
const getTarget = getPropOr({}, "target");
const getDetail = getPropOr(null, "detail");
const getToken = getPropOr(null, "token");

export default function App() {
  const stripeRef = useRef(null);
  const [publishableKey, setPublishableKey] = useState(null);
  const [disabled, setDisabled] = useState(true);
  const [token, setToken] = useState(null);
  const [error, setError] = useState(null);
  const setKey = ({ target: { value } }) => setPublishableKey(value);

  const onChange = compose(setDisabled, isDisabled, getTarget);
  const onError = compose(setError, getDetail);
  const onToken = compose(setToken, getToken);

  const onClick = async () =>
    stripeRef.current.createToken()
      .then(getToken)
      .then(setToken);

  return (
    <article className="App">
      <mwc-textfield
        label="Publishable Key"
        onChange={setKey}
        value={publishableKey}
      />
      <stripe-elements
        ref={stripeRef}
        onstripe-change={onChange}
        onstripe-error={onError}
        onstripe-token={onToken}
        publishable-key={publishableKey}
      />
      <mwc-button onClick={onClick} disabled={disabled}>
        Submit
      </mwc-button>
      {token && <output>{token.id}</output>}
      {error && <output>{error.message}</output>}
    </article>
  );
}
```

## API

<Props of="stripe-elements" />
